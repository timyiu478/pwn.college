---
tags: ["Reverse Engineering"]
title: "A Basic cIMG in x86"
description: A Basic cIMG in x86
reference: https://pwn.college/intro-to-cybersecurity/reverse-engineering/
---

# Problem

It's time to upgrade to a new version of the cIMG, getting much closer to usurping the boring old image formats of the web. Spot what's different, understand what /challenge/cimg wants, and get the flag!

# Solution

## 1. disassemble the binary

main function:

```
Dump of assembler code for function main:
   0x0000000000401264 <+0>:	endbr64
   0x0000000000401268 <+4>:	push   %r12
   0x000000000040126a <+6>:	mov    %edi,%r8d
   0x000000000040126d <+9>:	mov    $0x12,%ecx
   0x0000000000401272 <+14>:	push   %rbp
   0x0000000000401273 <+15>:	push   %rbx
   0x0000000000401274 <+16>:	sub    $0x20,%rsp
   0x0000000000401278 <+20>:	mov    %fs:0x28,%rax
   0x0000000000401281 <+29>:	mov    %rax,0x18(%rsp)
   0x0000000000401286 <+34>:	xor    %eax,%eax
   0x0000000000401288 <+36>:	lea    0x6(%rsp),%rdi
   0x000000000040128d <+41>:	dec    %r8d
   0x0000000000401290 <+44>:	lea    0x6(%rsp),%rbp
   0x0000000000401295 <+49>:	rep stos %al,%es:(%rdi)
   0x0000000000401297 <+51>:	jle    0x4012e8 <main+132>
   0x0000000000401299 <+53>:	mov    0x8(%rsi),%r12
   0x000000000040129d <+57>:	or     $0xffffffffffffffff,%rcx
   0x00000000004012a1 <+61>:	lea    0xe48(%rip),%rsi        # 0x4020f0
   0x00000000004012a8 <+68>:	mov    %r12,%rdi
   0x00000000004012ab <+71>:	repnz scas %es:(%rdi),%al
   0x00000000004012ad <+73>:	not    %rcx
   0x00000000004012b0 <+76>:	lea    -0x6(%r12,%rcx,1),%rdi
   0x00000000004012b5 <+81>:	call   0x4011b0 <strcmp@plt>
   0x00000000004012ba <+86>:	test   %eax,%eax
   0x00000000004012bc <+88>:	je     0x4012d3 <main+111>
   0x00000000004012be <+90>:	lea    0xe31(%rip),%rsi        # 0x4020f6
   0x00000000004012c5 <+97>:	mov    $0x1,%edi
   0x00000000004012ca <+102>:	xor    %eax,%eax
   0x00000000004012cc <+104>:	call   0x4011d0 <__printf_chk@plt>
   0x00000000004012d1 <+109>:	jmp    0x40132a <main+198>
   0x00000000004012d3 <+111>:	xor    %esi,%esi
   0x00000000004012d5 <+113>:	mov    %r12,%rdi
   0x00000000004012d8 <+116>:	xor    %eax,%eax
   0x00000000004012da <+118>:	call   0x4011f0 <open@plt>
   0x00000000004012df <+123>:	xor    %esi,%esi
   0x00000000004012e1 <+125>:	mov    %eax,%edi
   0x00000000004012e3 <+127>:	call   0x401170 <dup2@plt>
   0x00000000004012e8 <+132>:	or     $0xffffffff,%r8d
   0x00000000004012ec <+136>:	xor    %edi,%edi
   0x00000000004012ee <+138>:	lea    0xe20(%rip),%rcx        # 0x402115
   0x00000000004012f5 <+145>:	mov    %rbp,%rsi
   0x00000000004012f8 <+148>:	mov    $0x12,%edx
   0x00000000004012fd <+153>:	call   0x40163b <read_exact>
   0x0000000000401302 <+158>:	cmpb   $0x63,0x6(%rsp)
   0x0000000000401307 <+163>:	jne    0x40131e <main+186>
   0x0000000000401309 <+165>:	cmpb   $0x49,0x7(%rsp)
   0x000000000040130e <+170>:	jne    0x40131e <main+186>
   0x0000000000401310 <+172>:	cmpb   $0x4d,0x8(%rsp)
   0x0000000000401315 <+177>:	jne    0x40131e <main+186>
   0x0000000000401317 <+179>:	cmpb   $0x47,0x9(%rsp)
   0x000000000040131c <+184>:	je     0x401332 <main+206>
   0x000000000040131e <+186>:	lea    0xe0e(%rip),%rdi        # 0x402133
   0x0000000000401325 <+193>:	call   0x401140 <puts@plt>
   0x000000000040132a <+198>:	or     $0xffffffff,%edi
   0x000000000040132d <+201>:	call   0x401200 <exit@plt>
   0x0000000000401332 <+206>:	cmpl   $0x2,0xa(%rsp)
   0x0000000000401337 <+211>:	lea    0xe12(%rip),%rdi        # 0x402150
   0x000000000040133e <+218>:	jne    0x401325 <main+193>
   0x0000000000401340 <+220>:	cmpq   $0x49,0xe(%rsp)
   0x0000000000401346 <+226>:	lea    0xe1f(%rip),%rdi        # 0x40216c
   0x000000000040134d <+233>:	jne    0x401325 <main+193>
   0x000000000040134f <+235>:	cmpw   $0x14,0x16(%rsp)
   0x0000000000401355 <+241>:	lea    0xe28(%rip),%rdi        # 0x402184
   0x000000000040135c <+248>:	jne    0x401325 <main+193>
   0x000000000040135e <+250>:	mov    $0x16d0,%edi
   0x0000000000401363 <+255>:	call   0x4011c0 <malloc@plt>
   0x0000000000401368 <+260>:	lea    0xe2e(%rip),%rdi        # 0x40219d
   0x000000000040136f <+267>:	mov    %rax,%rbx
   0x0000000000401372 <+270>:	test   %rax,%rax
   0x0000000000401375 <+273>:	je     0x401325 <main+193>
   0x0000000000401377 <+275>:	mov    $0x16d0,%edx
   0x000000000040137c <+280>:	mov    %rax,%rsi
   0x000000000040137f <+283>:	or     $0xffffffff,%r8d
   0x0000000000401383 <+287>:	xor    %edi,%edi
   0x0000000000401385 <+289>:	lea    0xe46(%rip),%rcx        # 0x4021d2
   0x000000000040138c <+296>:	call   0x40163b <read_exact>
   0x0000000000401391 <+301>:	movzwl 0x16(%rsp),%edx
   0x0000000000401396 <+306>:	imul   0xe(%rsp),%rdx
   0x000000000040139c <+312>:	xor    %eax,%eax
   0x000000000040139e <+314>:	cmp    %rax,%rdx
   0x00000000004013a1 <+317>:	je     0x4013d3 <main+367>
   0x00000000004013a3 <+319>:	movzbl 0x3(%rbx,%rax,4),%ecx
   0x00000000004013a8 <+324>:	inc    %rax
   0x00000000004013ab <+327>:	lea    -0x20(%rcx),%esi
   0x00000000004013ae <+330>:	cmp    $0x5e,%sil
   0x00000000004013b2 <+334>:	jbe    0x40139e <main+314>
   0x00000000004013b4 <+336>:	mov    0x2c85(%rip),%rdi        # 0x404040 <stderr@@GLIBC_2.2.5>
   0x00000000004013bb <+343>:	lea    0xe2c(%rip),%rdx        # 0x4021ee
   0x00000000004013c2 <+350>:	mov    $0x1,%esi
   0x00000000004013c7 <+355>:	xor    %eax,%eax
   0x00000000004013c9 <+357>:	call   0x401210 <__fprintf_chk@plt>
   0x00000000004013ce <+362>:	jmp    0x40132a <main+198>
   0x00000000004013d3 <+367>:	mov    %rbx,%rsi
   0x00000000004013d6 <+370>:	mov    %rbp,%rdi
   0x00000000004013d9 <+373>:	call   0x40168b <display>
   0x00000000004013de <+378>:	movzwl 0x16(%rsp),%ecx
   0x00000000004013e3 <+383>:	xor    %eax,%eax
   0x00000000004013e5 <+385>:	xor    %esi,%esi
   0x00000000004013e7 <+387>:	imul   0xe(%rsp),%rcx
   0x00000000004013ed <+393>:	mov    $0x1,%edx
   0x00000000004013f2 <+398>:	cmp    %rax,%rcx
   0x00000000004013f5 <+401>:	je     0x401415 <main+433>
   0x00000000004013f7 <+403>:	cmpb   $0x8c,(%rbx,%rax,4)
   0x00000000004013fb <+407>:	jne    0x40140e <main+426>
   0x00000000004013fd <+409>:	cmpb   $0x1d,0x1(%rbx,%rax,4)
   0x0000000000401402 <+414>:	jne    0x40140e <main+426>
   0x0000000000401404 <+416>:	cmpb   $0x40,0x2(%rbx,%rax,4)
   0x0000000000401409 <+421>:	cmovne %esi,%edx
   0x000000000040140c <+424>:	jmp    0x401410 <main+428>
   0x000000000040140e <+426>:	xor    %edx,%edx
   0x0000000000401410 <+428>:	inc    %rax
   0x0000000000401413 <+431>:	jmp    0x4013f2 <main+398>
   0x0000000000401415 <+433>:	xor    %ecx,%ecx
   0x0000000000401417 <+435>:	xor    %esi,%esi
   0x0000000000401419 <+437>:	cmp    %rcx,%rax
   0x000000000040141c <+440>:	je     0x40142c <main+456>
   0x000000000040141e <+442>:	cmpb   $0x20,0x3(%rbx,%rcx,4)
   0x0000000000401423 <+447>:	je     0x401427 <main+451>
   0x0000000000401425 <+449>:	inc    %esi
   0x0000000000401427 <+451>:	inc    %rcx
   0x000000000040142a <+454>:	jmp    0x401419 <main+437>
   0x000000000040142c <+456>:	cmp    $0x5b4,%esi
   0x0000000000401432 <+462>:	jne    0x401440 <main+476>
   0x0000000000401434 <+464>:	and    $0x1,%dl
   0x0000000000401437 <+467>:	je     0x401440 <main+476>
   0x0000000000401439 <+469>:	xor    %eax,%eax
   0x000000000040143b <+471>:	call   0x401546 <win>
   0x0000000000401440 <+476>:	mov    0x18(%rsp),%rax
   0x0000000000401445 <+481>:	xor    %fs:0x28,%rax
   0x000000000040144e <+490>:	je     0x401455 <main+497>
   0x0000000000401450 <+492>:	call   0x401160 <__stack_chk_fail@plt>
   0x0000000000401455 <+497>:	add    $0x20,%rsp
   0x0000000000401459 <+501>:	xor    %eax,%eax
   0x000000000040145b <+503>:	pop    %rbx
   0x000000000040145c <+504>:	pop    %rbp
   0x000000000040145d <+505>:	pop    %r12
   0x000000000040145f <+507>:	ret
```

## 2. create .cimg file

```python
     1	import struct
     2	
     3	with open("flag.cimg", "wb") as f:
     4	    magic = b"\x63\x49\x4d\x47"
     5	    version = 2
     6	    version = version.to_bytes(4, "little")
     7	    width = 73
     8	    width = width.to_bytes(8, "little")
     9	    height = 20
    10	    height = height.to_bytes(2, "little")
    11	
    12	
    13	    f.write(magic)
    14	    f.write(version)
    15	    f.write(width)
    16	    f.write(height)
    17	
    18	    for i in range(73*20-1460):
    19	       f.write(b"\x20\x20\x20\x20")
    20	    for i in range(1460):
    21	       f.write(b"\x8c\x1d\x40\x30")
```

## 3. run binary

```
hacker@reverse-engineering~a-basic-cimg-x86:/challenge$ ./cimg ~/flag.cimg
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000
pwn.college{gsuwmUsIdSevSzBye8FxEd-rMvZ.0lNwMDMxwCM0YjMyEzW}
```
